<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Space Invaders</title>
    <style>
      #gameContainer {
        width: 800px;
        margin: auto;
        margin-top: 50px;
      }
    </style>
  </head>
  <body>
    <h1>Hello World</h1>
    <div id="gameContainer"></div>
  </body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
  <script>
    let app;
    let player;
    //let enemy;
    let bullets = [];
    let enemyBullets = [];
    let enemyArr = [];
    let bulletSpeed = 5;
    window.onload = () => {
      //Create the stage
      app = new PIXI.Application({
        width: 800,
        height: 600,
        backgroundColor: 0xaaaaaa
      });
      document.querySelector("#gameContainer").appendChild(app.view);

      let gameCtr = document.querySelector("#gameContainer");

      //Making player object

      player = new PIXI.Sprite.from("./images/player.png");
      player.anchor.set(0.5);
      player.x = app.view.width / 2;
      player.y = app.view.height - 24;
      app.stage.addChild(player);

      app.ticker.add(gameLoop);

      //making container with enemy

      container = new PIXI.Container();
      app.stage.addChild(container);

      //making enemy object

      const texture = PIXI.Texture.from("./images/enemy.png");

      for (let i = 0; i < 20; i++) {
        const enemy = new PIXI.Sprite(texture);

        enemyArr.push(enemy);

        enemy.anchor.set(0.5);
        enemy.x = (i % 5) * 50;
        enemy.y = Math.floor(i / 5) * 36;
        container.addChild(enemy);
      }

      //for test
      //   const enemy = new PIXI.Sprite(texture);
      //   enemy.width = 8;
      //   enemy.height = 8;
      //   enemyArr.push(enemy);
      //   container.addChild(enemy);

      container.x = app.screen.width / 2;
      container.y = app.screen.height / 2;
      //container.pivot.x = container.width / 2;
      //container.pivot.y = container.height / 2;
      container.vx = 5;

      container.vy = 5;

      //move enemy container

      setInterval(() => {
        enemyFireBullet();
      }, 700);
      app.ticker.add(containerMove);

      function containerMove(delta) {
        container.y += container.vy;
        container.x += container.vx;
        container.vy += 0.1;

        if (container.y > 500) {
          container.vy *= -1.01;
          container.y += container.vy;
        }

        if (container.x > 660) {
          container.vx *= -1;
          container.x += container.vx;
        }
        if (container.x < 0) {
          container.vx *= -1;
          container.x += container.vx;
        }
      }

      //keyboard event handler TBD

      //Mouse interactions

      app.stage.interactive = true;
      app.stage.on("pointermove", movePlayer);

      document
        .querySelector("#gameContainer")
        .addEventListener("pointerdown", fireBullet);

      //   document
      //     .querySelector("#gameContainer")
      //     .addEventListener("pointerdown", enemyFireBullet);
    };

    function updateBullets(delta) {
      for (let i = 0; i < bullets.length; i++) {
        bullets[i].position.y -= bullets[i].speed;

        if (bullets[i].position.y < 0) {
          bullets[i].bulletGone = true;
        }
      }

      for (let i = 0; i < bullets.length; i++) {
        if (bullets[i].bulletGone) {
          app.stage.removeChild(bullets[i]);
          bullets.splice(i, 1);
        }
      }

      //enemy shoot
      for (let i = 0; i < enemyBullets.length; i++) {
        enemyBullets[i].position.y += enemyBullets[i].speed;

        if (enemyBullets[i].position.y > 600) {
          enemyBullets[i].bulletGone = true;
        }
        if (enemyBullets[i].bulletGone) {
          app.stage.removeChild(enemyBullets[i]);
          enemyBullets.splice(i, 1);
        }
      }
    }

    function movePlayer(event) {
      let position = event.data.global;
      //player follow mouse cursor
      player.x = position.x;
      //player.y = position.y;
    }

    function fireBullet(event) {
      let bullet = createBullet();
      bullets.push(bullet);
    }
    function createBullet() {
      let bullet = new PIXI.Sprite.from("./images/bullet.png");
      bullet.anchor.set(0.5);
      bullet.x = player.x;
      bullet.y = player.y;
      bullet.width = 8;
      bullet.height = 8;
      bullet.speed = bulletSpeed;
      app.stage.addChild(bullet);

      return bullet;
    }
    function getRandomEnemy() {
      return Math.round(Math.random() * (enemyArr.length - 1));
    }

    function enemyFireBullet() {
      let enemyBullet = createEnemyBullet();
      enemyBullets.push(enemyBullet);
    }

    function createEnemyBullet() {
      let enemyBullet = new PIXI.Sprite.from("./images/enemyBullet.png");
      enemyBullet.anchor.set(0.5);

      enemyBullet.x = enemyArr[getRandomEnemy()].getGlobalPosition().x;
      enemyBullet.y = enemyArr[getRandomEnemy()].getGlobalPosition().y;
      enemyBullet.speed = 2;

      app.stage.addChild(enemyBullet);
      return enemyBullet;
    }

    function gameLoop() {
      updateBullets();

      for (let i = 0; i < enemyArr.length; i++) {
        for (let j = 0; j < bullets.length; j++) {
          if (bullets[j] && hitTestRectangle(bullets[j], enemyArr[i])) {
            container.removeChild(enemyArr[i]);

            enemyArr.splice(i, 1);

            app.stage.removeChild(bullets[j]);
            bullets.splice(j, 1);
            break;
          }
        }
      }

      for (let i = 0; i < enemyBullets.length; i++) {
        if (enemyBullets[i] && hitTestRectangle2(player, enemyBullets[i])) {
          console.log("GAME OVER");
        }
      }
    }

    function hitTestRectangle(r1, r2) {
      var rect1 = { x: r1.x, y: r1.y, width: r1.width, height: r1.height };
      var rect2 = {
        x: r2.x + container.x,
        y: r2.y + container.y,
        width: r2.width,
        height: r2.height
      };

      //console.log( r2.x+container.x);
      if (
        rect1.x < rect2.x + rect2.width &&
        rect1.x + rect1.width > rect2.x &&
        rect1.y < rect2.y + rect2.height &&
        rect1.y + rect1.height > rect2.y
      ) {
        return true;
        // collision detected!
      }
    }

    function hitTestRectangle2(r1, r2) {
      var rect1 = { x: r1.x, y: r1.y, width: r1.width, height: r1.height };
      var rect2 = {
        x: r2.x,
        y: r2.y,
        width: r2.width,
        height: r2.height
      };

      //console.log( r2.x+container.x);
      if (
        rect1.x < rect2.x + rect2.width &&
        rect1.x + rect1.width > rect2.x &&
        rect1.y < rect2.y + rect2.height &&
        rect1.y + rect1.height > rect2.y
      ) {
        return true;
        // collision detected!
      }
    }
  </script>
</html>
